# Equilibria Structural Stabilization Plan (CRI + Baseline Alignment)

## Source Context
This plan is derived from `AGENTS.md` section `Current Operational Status - February 19, 2026` (`AGENTS.md:480`).

Confirmed status on February 19, 2026:
- `pep2` + `equation_consistent` is numerically stable.
- Remaining instability is concentrated in CRI data runs and baseline alignment modes (`strict_gams` slice compatibility and macro closure tension).
- CRI fixed SAM provenance is confirmed:
  - Generated by `/Users/marmol/proyectos/cge_babel/sam/cri/2016/export_gams_format.py`
  - Generator input: `output/SAM-V2_0.xlsx` (`export_gams_format.py:243`)
  - Generator output: `output/SAM-CRI.xlsx` (`export_gams_format.py:285`, export call `:289-292`)
  - Equilibria file: `src/equilibria/templates/reference/pep2/data/SAM-CRI-gams-fixed.xlsx`
  - Identity check (source vs equilibria): same size (`9094` bytes), same SHA1 (`e4192240b11e8faadc5d6e3c3c7367f45dfe05a1`), `cmp` exit code `0`.

Complementary finding document:
- `docs/findings/finding_sam_ieem_vs_sam_pep.md`
- Root cause summary:
  - export-account architecture mismatch in IEEM -> PEP conversion (`I/X/ROW` vs `J->X` split),
  - production-tax routing drift (`AG.ti -> J` vs `AG.gvt -> J` in PEP calibration expectations),
  - IEEM closes due to different architecture plus diagnostics/sambal pre-solve pipeline.

## Goal
Implement a structural fix in Equilibria so instability is prevented by architecture and contracts, not by ad-hoc solver tuning.

## Design Principles
1. Data contracts before equations.
2. Explicit initialization modes with strict boundaries.
3. Baseline compatibility must be machine-verifiable.
4. Fail early with actionable diagnostics.
5. CI gates enforce parity and closure invariants.

## Structural Changes

### 1. Add a Mandatory Data-Contract Layer (Pre-Calibration)
Create a first-class QA subsystem that validates SAM and tax/margin/macro identities before calibration or solve.

Planned components:
- `src/equilibria/qa/sam_contracts.py`
- `src/equilibria/qa/sam_checks.py`
- `src/equilibria/qa/reporting.py`
- `scripts/qa/run_sam_qa.py`

Mandatory checks:
- Export/domestic supply consistency by commodity/sector.
- Margin normalization consistency (`tmrg`, `tmrg_X`, margin totals).
- Tax-base consistency (`EQ29`, `EQ39`, `EQ40`-aligned aggregates).
- Macro closure checks (`GDP_MP`, `GDP_IB`, `GDP_FD`, `CAB`, Walras proxy).
- Conversion-architecture checks (IEEM -> PEP):
  - no duplicated external-demand representation (`I.i -> AG.ROW` and `X.i -> AG.ROW`) without valid `J.j -> X.i` support,
  - production-tax account routing consistent with PEP blocks (`AG.gvt -> J`, `AG.ti -> I`).

Policy:
- `hard_fail`: incompatible data rejected before calibration.
- `auto_fix`: only for deterministic, auditable transformations; every fix logged.

### 2. Introduce Baseline Compatibility Manifests
`strict_gams` must not run unless the baseline slice is compatible with the active SAM/VAL_PAR inputs.

Planned components:
- `src/equilibria/baseline/manifest.py`
- `src/equilibria/baseline/compatibility.py`

Manifest fields:
- Hash/signature of SAM source.
- Hash/signature of VAL_PAR source.
- GDX slice ID (scenario/run metadata).
- Set cardinalities and key aggregates used in parity checks.

Runtime behavior:
- `strict_gams` with mismatch -> fail fast with clear incompatibility report.
- `equation_consistent`/`gams_blockwise` remain available for identity-consistent starts.

### 3. Refactor Initialization into Strategy + Contracts
Replace implicit branching with explicit, testable strategy classes.

Planned components:
- `src/equilibria/templates/init_strategies/base.py`
- `src/equilibria/templates/init_strategies/equation_consistent.py`
- `src/equilibria/templates/init_strategies/gams_blockwise.py`
- `src/equilibria/templates/init_strategies/strict_gams.py`

Requirements:
- Each strategy declares required inputs.
- No silent fallback in `strict_gams`.
- Shared post-init validation hook with block-level residual gates.

### 4. Centralize Array<->Variable Transform Safeguards
Move CES/CET/tax reconstruction guards into one canonical transform layer.

Planned components:
- `src/equilibria/solver/transforms.py`
- `src/equilibria/solver/guards.py`

Rules:
- One canonical reconstruction path.
- Corner-case handling (0/1 shares, near-zero denominators) is deterministic and logged.
- Reused by both initialization checks and solve path.

### 5. Promote Parity Gates to Hard CI Contracts
Current parity checks become required CI quality gates, not optional diagnostics.

Planned CI gates:
- Data-contract gate (SAM QA) must pass for CRI inputs.
- Init gate: block residual thresholds for selected mode.
- Parity gate: `EQ29/EQ39/EQ40`, `EQ79/EQ84`, levels parity when applicable.
- Solve gate: if `--method != none`, non-convergence returns non-zero (already present; keep mandatory).

## Implementation Phases

### Phase A: Data-Contract Foundation
Status: ✅ Completed

Deliverables:
- SAM QA module + `run_sam_qa.py`.
- JSON report schema with machine-readable failure codes.
- Integration in calibration entrypoint (pre-check required).

Exit criteria:
- CRI incompatible mappings are rejected before calibration.
- QA report identifies failing contract and affected symbols.

### Phase B: Baseline Compatibility + Init Strategy Split
Status: ✅ In progress (baseline compatibility + strategy split completed)

Deliverables:
- Baseline manifest generator and compatibility checker.
- Refactored init strategy classes with explicit requirements.
- `strict_gams` hard-fail on manifest mismatch.

Exit criteria:
- No ambiguous `strict_gams` execution against incompatible `Results.gdx` slices.
- Mode behavior is deterministic and independently testable.

Implemented in this cycle:
- `src/equilibria/baseline/manifest.py` and `src/equilibria/baseline/compatibility.py`
- `src/equilibria/templates/init_strategies/base.py`
- `src/equilibria/templates/init_strategies/strict_gams.py`
- `src/equilibria/templates/init_strategies/equation_consistent.py`
- `src/equilibria/templates/init_strategies/gams_blockwise.py`
- `src/equilibria/templates/pep_model_solver_ipopt.py` now dispatches via strategy classes

### Phase C: Canonical Transform + Solver Integration
Status: ✅ Completed

Deliverables:
- Unified transform/guard layer used by init and solve.
- Removal of duplicated reconstruction logic.

Exit criteria:
- No drift between init residual checks and solve residual math.
- Stable behavior on CES/CET edge cases across modes.

Implemented in this cycle:
- `src/equilibria/solver/transforms.py` (`pep_array_to_variables`, `pep_variables_to_array`)
- `src/equilibria/solver/guards.py` (`rebuild_tax_detail_from_rates`)
- IPOPT transform calls now use canonical layer in both objective path and solver packing.
- Initialization/equation-consistent tax-detail reconstruction now reuses shared guard function.
- `src/equilibria/templates/pep_model_solver.py` now uses the same canonical transform/guard path.

### Phase D: CI Hardening + Regression Suite
Status: ✅ Completed

Deliverables:
- Contract tests for QA/baseline compatibility.
- Integration tests for `pep2` and CRI pipelines.
- Fail-fast parity pipeline enforced in CI.

Exit criteria:
- `pep2` deterministic pass.
- CRI failures are classified as data-contract vs solver dynamics (not ambiguous).

Implemented in this cycle:
- `tests/scripts/test_run_pep_systemic_parity_classification.py` now validates end-to-end report classification for:
  - CRI fail-fast (`classification.kind=data_contract`)
  - CRI fixed pass (`classification.kind=pass`, `macro_closure` gate passed)
  - pep2 pass (`classification.kind=pass`)
  - forced solve non-convergence after passing init (`classification.kind=solver_dynamics`)
- `src/equilibria/templates/init_strategies/equation_consistent.py` now applies macro closure reconciliation before GDP recomputation.
- `.github/workflows/tests.yml` now includes `structural-cri-contract-gate`:
  - runs systemic parity on `SAM-CRI-gams.xlsx` with `--dynamic-sam`
  - requires exit code `2`
  - asserts report classification is `data_contract/sam_qa_failed`
- `.github/workflows/tests.yml` now includes `structural-cri-fixed-pass-gate`:
  - runs systemic parity on `SAM-CRI-gams-fixed.xlsx` with `equation_consistent`
  - requires pass classification and `sam_qa.passed=true`
  - asserts `macro_closure` gate pass
- `.github/workflows/tests.yml` now includes `structural-solver-dynamics-gate`:
  - runs systemic parity on pep2 with `equation_consistent` + `simple_iteration --max-iterations 0`
  - requires exit code `2`
  - asserts `init.gates.overall_passed=true` and classification `solver_dynamics/solve_not_converged`
- `.github/workflows/tests.yml` now includes `structural-cri-solver-dynamics-gate`:
  - runs systemic parity on `SAM-CRI-gams-fixed.xlsx` with `equation_consistent` + `simple_iteration --max-iterations 0`
  - requires exit code `2`
  - asserts `sam_qa.passed=true`, `init.gates.overall_passed=true`, and classification `solver_dynamics/solve_not_converged`
- `scripts/qa/print_structural_report_summary.py` prints compact CI summaries:
  - `classification.kind`, `classification.reason`, `first_failed_block`
  - `sam_qa.passed`, `init.gates.overall_passed`, `solve.converged`
- CI now uploads parity/contract JSON reports as artifacts for all structural gate jobs.

Note:
- CRI `solver_dynamics` attribution is now deterministic in CI via forced non-convergence (`simple_iteration --max-iterations 0`) after QA/init pass.
- This gate is structural (classification semantics), not a claim about naturally occurring CRI solve failure.

## Acceptance Targets
1. `pep2` (`equation_consistent`) remains near machine precision at init.
2. `strict_gams` only runs when baseline manifest is compatible.
3. CRI runs fail early on data inconsistency with explicit contract violations.
4. Macro closure tension is reported with attribution (data mapping vs solve dynamics).
5. No silent fallback paths in strict parity mode.

## Execution Order (Recommended)
1. Phase A (Data contracts)
2. Phase B (Baseline compatibility + init strategy split)
3. Phase C (Canonical transforms)
4. Phase D (CI hardening)

## Immediate Next Actions
1. Keep strict parity tolerances under CI observation and tune only with explicit contract justification.
2. Add a natural (non-forced) CRI stress case that passes init gates and fails solve to complement the forced structural classification gate.
3. Extend CI reporting to aggregate structural summaries across jobs in a single consolidated artifact/table.
